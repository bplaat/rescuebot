<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RescueBot</title>
    <style>
        html,.root{height:100%}body{margin:0;height:100%;color:#111;background-color:#fff}
        body,button{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;font-size:16px;line-height:1.5}
        .logo{padding:16px;font-size:20px;font-weight:bold}
        .flex{flex:1}.flex-horizontal{display:flex}.flex-vertical{display:flex;flex-direction:column}
        .data{color:#444;font-family:'Courier New',Courier,monospace;text-align:center;line-height:64px;}
        .auto-control-button-on{color:#fff;background-color:#6b6}
        .auto-control-button-off{color:#fff;background-color:#e22}
        @media (max-width: 640px) {
            .mobile-flex-vertical{flex-direction:column}
            .data{text-align:left;line-height:1.5}
            .logo,.data,.auto-control-button{padding:8px}
        }
    </style>
</head>
<body>
    <div class="root flex-vertical">
        <div class="flex-horizontal mobile-flex-vertical">
            <div class="logo">RescueBot <span id="rescuebot-name-label"></span></div>
            <div id="state-label" class="data flex">- Still</div>
            <div id="last-border-position-label" class="data flex">Border position unkown</div>
            <button id="auto-control-button" class="flex auto-control-button auto-control-button-off">Auto control off</button>
        </div>
        <div class="flex flex-horizontal">
            <button id="turn-left-button" class="flex">&larr; Left</button>
            <div class="flex flex-vertical">
                <button id="move-forward-button" class="flex">&uarr; Forward</button>
                <button id="move-backward-button" class="flex">&darr; Backward</button>
            </div>
            <button id="turn-right-button" class="flex">Right &rarr;</button>
        </div>
    </div>
    <script>
        var rescuebot_name = '';

        var BORDER_UNKOWN = 0;

        var border_strings = [
            'Border position unkown',
            'Border position left',
            'Border position right'
        ];

        var last_border_position = BORDER_UNKOWN;

        var STATE_STILL = 0;
        var STATE_MOVE_FORWARD = 1;

        var STATE_OVERIDE_MOVE_FORWARD = 13;
        var STATE_OVERIDE_TURN_LEFT = 14;
        var STATE_OVERIDE_TURN_RIGHT = 15;
        var STATE_OVERIDE_MOVE_BACKWARD = 16;

        var state = STATE_STILL;

        var state_strings = [
            '- Still',
            '\u2191 Moving forward',

            '\u2192 Avoid left border',
            '\u2190 Avoid right border',

            '\u2193 Avoid object by moving backward',
            '\u2190 Avoid object by turning left',
            '\u2192 Avoid object by turning right',
            '\u2191 Avoid object by moving forward',
            '\u2190 Avoid object by turning left',
            '\u2192 Avoid object by turning right',

            '\u2193 Avoid cliff by moving backward',
            '\u2190 Avoid cliff by turning left',
            '\u2192 Avoid cliff by turning right',

            '\u2191 Overide moving forward',
            '\u2190 Overide turning left',
            '\u2192 Overide turning right',
            '\u2193 Overide moving backward',

            '\u2191 Tunnel moving forward'
        ];

        var auto_control = false;

        var rescuebot_name_label = document.getElementById('rescuebot-name-label');
        var state_label = document.getElementById('state-text-label');
        var last_border_position_label = document.getElementById('last-border-position-label');

        var auto_control_button = document.getElementById('auto-control-button');
        var move_forward_button = document.getElementById('move-forward-button');
        var turn_left_button = document.getElementById('turn-left-button');
        var turn_right_button = document.getElementById('turn-right-button');
        var move_backward_button = document.getElementById('move-backward-button');

        function update_auto_control (new_auto_control) {
            auto_control = new_auto_control;
            if (auto_control) {
                auto_control_button.classList.add('auto-control-button-on');
                auto_control_button.classList.remove('auto-control-button-off');
                auto_control_button.textContent = 'Auto control on';

                move_forward_button.disabled = true;
                turn_left_button.disabled = true;
                turn_right_button.disabled = true;
                move_backward_button.disabled = true;
            } else {
                auto_control_button.classList.add('auto-control-button-off');
                auto_control_button.classList.remove('auto-control-button-on');
                auto_control_button.textContent = 'Auto control off';

                move_forward_button.disabled = false;
                turn_left_button.disabled = false;
                turn_right_button.disabled = false;
                move_backward_button.disabled = false;
            }
        }

        function update_state () {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/update_state?auto_control=' + (auto_control ? 'true' : 'false') + '&state=' + state, true);
            xhr.send();
        }

        function load_state () {
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                var data = JSON.parse(xhr.responseText);

                if (data.rescuebot_name != rescuebot_name) {
                    rescuebot_name = data.rescuebot_name;
                    rescuebot_name_label.textContent = rescuebot_name;
                }

                if (data.last_border_position != last_border_position) {
                    last_border_position = data.last_border_position;
                    last_border_position_label.textContent = border_strings[last_border_position];
                }

                if (data.auto_control != auto_control) {
                    update_auto_control(data.auto_control);
                }

                if (data.state != state) {
                    state = data.state;
                    state_label.textContent = state_strings[state];
                }

                setTimeout(load_state, 250);
            };
            xhr.onerror = function () {
                setTimeout(load_state, 500);
            };
            xhr.open('GET', '/api/get_state', true);
            xhr.send();
        }

        auto_control_button.addEventListener('click', function () {
            update_auto_control(!auto_control);
            state = auto_control ? STATE_MOVE_FORWARD : STATE_STILL;
            update_state();
        }, false);

        function stop_motor () {
            state = STATE_STILL;
            update_state();
        }

        move_forward_button.addEventListener('mousedown', function () {
            state = STATE_OVERIDE_MOVE_FORWARD;
            update_state();
        }, false);

        move_forward_button.addEventListener('mouseup', stop_motor, false);

        turn_left_button.addEventListener('mousedown', function () {
            state = STATE_OVERIDE_TURN_LEFT;
            update_state();
        }, false);

        turn_left_button.addEventListener('mouseup', stop_motor, false);

        turn_right_button.addEventListener('mousedown', function () {
            state = STATE_OVERIDE_TURN_RIGHT;
            update_state();
        }, false);

        turn_right_button.addEventListener('mouseup', stop_motor, false);

        move_backward_button.addEventListener('mousedown', function () {
            state = STATE_OVERIDE_MOVE_BACKWARD;
            update_state();
        }, false);

        move_backward_button.addEventListener('mouseup', stop_motor, false);

        load_state();
    </script>
</body>
</html>
